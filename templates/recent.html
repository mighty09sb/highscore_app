<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æœ€è¿‘ã®ã‚²ãƒ¼ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background-color: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <h1 id="game-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
  <table id="ranking-table">
    <tr>
      <th>é †ä½</th>
      <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
      <th>ã‚¹ã‚³ã‚¢</th>
      <th>å¤‰åŒ–</th>
      <th>è¨˜éŒ²æ—¥æ™‚</th>
    </tr>
  </table>

  <script>
    let gameIndex = 0;
    let gameIds = [];

    async function fetchRecentGameIds() {
      const response = await fetch('/api/recent_games');
      gameIds = await response.json();
    }

    async function fetchAndShowRanking(gameId) {
      const res = await fetch(`/ranking/${gameId}`);
      const data = await res.json();

      const table = document.getElementById('ranking-table');
      const title = document.getElementById('game-title');
      title.textContent = `ã‚²ãƒ¼ãƒ  ID: ${gameId} ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°`;

      // Remove old rows except header
      while (table.rows.length > 1) table.deleteRow(1);

      data.forEach((entry, index) => {
        const row = table.insertRow();
        row.insertCell().textContent = index + 1;
        row.insertCell().textContent = entry.username;
        row.insertCell().textContent = entry.score;

        // å¤‰åŒ–
        const changeCell = row.insertCell();
        const change = entry.change || '';
        if (['â†‘', 'â¬†', 'new', 'New', 'ğŸ†•'].includes(change)) {
          changeCell.innerHTML = `<span style="color: blue;">${change}</span>`;
        } else if (['â†“', 'â¬‡'].includes(change)) {
          changeCell.innerHTML = `<span style="color: red;">${change}</span>`;
        } else {
          changeCell.innerHTML = change || '&nbsp;';
        }

        // æ—¥æ™‚
        const timestampCell = row.insertCell();
        if (entry.timestamp) {
          const jstDate = new Date(entry.timestamp).toLocaleString('ja-JP', {
            timeZone: 'Asia/Tokyo',
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
          timestampCell.textContent = jstDate;
        } else {
          timestampCell.textContent = 'N/A';
        }
      });
    }

    async function cycleThroughGames() {
      await fetchRecentGameIds();

      if (gameIds.length === 0) {
        document.getElementById('game-title').textContent = 'æœ€è¿‘ã®æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }

      async function updateRanking() {
        const gameId = gameIds[gameIndex];
        await fetchAndShowRanking(gameId);

        gameIndex++;
        if (gameIndex >= gameIds.length) {
          gameIndex = 0;
          await fetchRecentGameIds();  // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
        }
      }

      updateRanking();  // åˆå›è¡¨ç¤º
      setInterval(updateRanking, 60000); // 60ç§’ã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆ
    }

    cycleThroughGames();
  </script>
</body>
</html>

